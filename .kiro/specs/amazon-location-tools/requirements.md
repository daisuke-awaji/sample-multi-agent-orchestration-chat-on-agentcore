# Amazon Location Service ツール実装

## 概要

Amazon Location Service を活用した位置情報関連ツールを `packages/lambda-tools/tools/utility-tools/src/tools` に実装します。このツールは AgentCore Gateway 経由で AI エージェントから利用可能になります。

## 背景

現在のシステムには位置情報を扱う機能がありません。Amazon Location Service を統合することで、以下のような位置情報ベースの機能を AI エージェントに提供できます：

- 住所から座標への変換（ジオコーディング）
- 座標から住所への変換（逆ジオコーディング）
- 場所の検索（POI検索）
- ルート計算と経路案内
- 近隣の場所検索

## ユーザーストーリー

### 1. ジオコーディング機能

**As a** AI エージェント利用者  
**I want to** 住所やランドマーク名から緯度経度を取得したい  
**So that** 地図上での位置表示や他の位置情報サービスと連携できる

**受け入れ基準:**
- 1.1 住所文字列（例: "東京都渋谷区渋谷1-1-1"）を入力として受け取れる
- 1.2 緯度経度の座標を返す
- 1.3 複数の候補がある場合は関連度順にリストで返す
- 1.4 住所の詳細情報（国、都道府県、市区町村など）も含める
- 1.5 検索範囲を指定できる（バイアス位置、境界ボックス）
- 1.6 最大結果数を制限できる

### 2. 逆ジオコーディング機能

**As a** AI エージェント利用者  
**I want to** 緯度経度から住所を取得したい  
**So that** 座標情報を人間が理解しやすい住所形式で表示できる

**受け入れ基準:**
- 2.1 緯度経度（例: [35.6581, 139.7414]）を入力として受け取れる
- 2.2 その位置に最も近い住所を返す
- 2.3 住所の詳細情報（国、都道府県、市区町村、郵便番号など）を含める
- 2.4 最寄りのランドマークや POI 情報も含める（可能な場合）

### 3. 場所検索機能

**As a** AI エージェント利用者  
**I want to** キーワードで場所を検索したい  
**So that** レストラン、ホテル、観光地などの情報を取得できる

**受け入れ基準:**
- 3.1 検索キーワード（例: "渋谷 カフェ"）を入力として受け取れる
- 3.2 関連する場所のリストを返す
- 3.3 各場所の詳細情報を含める：
  - 名前、住所、座標
  - カテゴリ（POI タイプ）
  - 営業時間（利用可能な場合）
  - 連絡先情報（利用可能な場合）
- 3.4 検索範囲を指定できる（中心座標と半径、または境界ボックス）
- 3.5 カテゴリフィルタを適用できる
- 3.6 最大結果数を制限できる

### 4. ルート計算機能

**As a** AI エージェント利用者  
**I want to** 出発地から目的地までのルートを計算したい  
**So that** 移動時間、距離、経路を提案できる

**受け入れ基準:**
- 4.1 出発地と目的地の座標を入力として受け取れる
- 4.2 経由地（ウェイポイント）を最大23箇所指定できる
- 4.3 移動手段を指定できる（車、徒歩、トラックなど）
- 4.4 回避条件を指定できる（有料道路、フェリーなど）
- 4.5 以下の情報を返す：
  - 総移動距離
  - 推定移動時間
  - ターンバイターンの経路案内
  - 経路の座標リスト（ポリライン）
- 4.6 出発時刻を指定して交通状況を考慮できる

### 5. 近隣検索機能

**As a** AI エージェント利用者  
**I want to** 指定した位置の近くにある場所を検索したい  
**So that** 「現在地から最寄りのコンビニ」などの情報を提供できる

**受け入れ基準:**
- 5.1 中心座標と検索半径を入力として受け取れる
- 5.2 カテゴリフィルタを適用できる
- 5.3 距離順にソートされた結果を返す
- 5.4 各結果に中心座標からの距離を含める
- 5.5 最大結果数を制限できる

## 技術要件

### 必須要件

1. **AWS SDK 統合**
   - `@aws-sdk/client-location` を使用
   - 既存の AWS 認証情報を利用
   - エラーハンドリングとリトライロジックを実装

2. **ツール構造**
   - 既存のツールパターン（echo.ts, ping.ts）に従う
   - `Tool` インターフェースを実装
   - 適切な型定義（Input/Result）を提供

3. **入力検証**
   - 必須パラメータのバリデーション
   - 座標の範囲チェック（緯度: -90〜90, 経度: -180〜180）
   - 文字列の長さ制限

4. **エラーハンドリング**
   - `ToolValidationError` を使用した入力エラー
   - AWS API エラーの適切な処理
   - ユーザーフレンドリーなエラーメッセージ

5. **ロギング**
   - 既存の logger を使用
   - リクエスト/レスポンスの記録
   - パフォーマンスメトリクスの記録

### オプション要件

1. **キャッシング**
   - 頻繁に検索される場所の結果をキャッシュ
   - TTL ベースのキャッシュ無効化

2. **レート制限**
   - API 呼び出しの制限を実装
   - バックオフとリトライ戦略

3. **バッチ処理**
   - 複数の場所を一度に検索
   - ルート最適化

## 制約事項

1. **AWS リソース**
   - Amazon Location Service のリソース（Place Index, Route Calculator）が事前に作成されている必要がある
   - リソース名は環境変数で設定可能にする

2. **API 制限**
   - Amazon Location Service の API クォータに従う
   - 大量のリクエストには適切なレート制限を実装

3. **データプロバイダー**
   - 使用するデータプロバイダー（Esri, HERE など）によって機能が異なる
   - プロバイダー固有の制限を考慮

4. **コスト**
   - API 呼び出しごとに課金される
   - 不要なリクエストを避ける最適化が必要

## 成功基準

1. 5つの主要機能（ジオコーディング、逆ジオコーディング、場所検索、ルート計算、近隣検索）がすべて実装されている
2. 各ツールが既存のツールレジストリに正しく登録される
3. 単体テストのカバレッジが80%以上
4. エラーケースが適切に処理される
5. ドキュメントが完備されている（JSDoc コメント）
6. AgentCore Gateway 経由でツールが正常に呼び出せる

## 実装の優先順位

### Phase 1: 基本機能（必須）
1. ジオコーディング（geocode）
2. 逆ジオコーディング（reverse-geocode）
3. 場所検索（search-places）

### Phase 2: 高度な機能
4. ルート計算（calculate-route）
5. 近隣検索（search-nearby）

### Phase 3: 最適化（オプション）
6. キャッシング機能
7. バッチ処理
8. レート制限

## 参考資料

- [Amazon Location Service API Reference](https://docs.aws.amazon.com/location/latest/APIReference/welcome.html)
- [AWS SDK for JavaScript v3 - Location Client](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-location/)
- [Amazon Location Service Developer Guide](https://docs.aws.amazon.com/location/latest/developerguide/)
