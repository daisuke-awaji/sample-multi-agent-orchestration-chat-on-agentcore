openapi: 3.0.3
info:
  title: AgentCore Agent Runtime Streaming API
  version: 0.1.0
  description: |
    AI Agent streaming API using Strands Agents SDK.

    ## Overview
    This API provides a real-time streaming interface for interacting with AI agents.
    Send a prompt via HTTP POST and receive streaming responses in NDJSON (Newline Delimited JSON) format.

    ## Streaming Protocol
    - **Protocol**: HTTP POST + NDJSON Streaming
    - **Content-Type**: `text/plain; charset=utf-8`
    - **Response Format**: Newline-delimited JSON objects
    - **Real-time**: Text generation and tool execution displayed in real-time

    ## Authentication
    Requires JWT Bearer Token in the `Authorization` header.
    User ID is extracted from JWT payload claims (sub, userId, user_id, or username).
    Direct access typically goes through Backend API which forwards the JWT.

    ## Session Management
    Optionally use `X-Amzn-Bedrock-AgentCore-Runtime-Session-Id` header to manage
    conversation history across requests.

  contact:
    name: AgentCore Runtime
    url: https://github.com/your-org/fullstack-agentcore
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development environment
  - url: https://{gateway-id}.bedrock-agentcore.{region}.amazonaws.com
    description: AWS AgentCore Runtime (production)
    variables:
      gateway-id:
        description: AgentCore Gateway ID
        default: default-gateway-abc123
      region:
        description: AWS Region
        enum:
          - us-east-1
          - us-west-2
          - ap-northeast-1
        default: us-east-1

paths:
  /:
    get:
      summary: Get Service Information
      description: Get basic information about the AgentCore Runtime service
      operationId: getServiceInfo
      tags:
        - Service
      responses:
        '200':
          description: Service information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInfo'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /ping:
    get:
      summary: Health Check
      description: Check service operational status
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Health check successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheck'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /invocations:
    post:
      summary: Invoke AI Agent (Streaming)
      description: |
        Send a prompt to the AI agent and receive real-time streaming response.

        ## Streaming Flow
        1. Send prompt via HTTP POST
        2. Receive NDJSON format streaming response from server
        3. Each line is an individual JSON event object
        4. Get real-time text generation and tool execution status

        ## Event Types
        - `modelContentBlockDeltaEvent`: Text generation (real-time)
        - `modelContentBlockStartEvent`: Tool use start
        - `beforeToolsEvent` / `afterToolsEvent`: Tool execution status
        - `serverCompletionEvent`: Processing complete
        - `serverErrorEvent`: Error occurred

        ## Usage Example
        ```bash
        curl -X POST http://localhost:8080/invocations \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
          -d '{"prompt": "Tell me about the weather in Tokyo"}' \
          --no-buffer
        ```

        ## Response Example
        ```
        {"type":"beforeInvocationEvent"}
        {"type":"modelContentBlockDeltaEvent","delta":{"type":"textDelta","text":"Hello"}}
        {"type":"modelContentBlockDeltaEvent","delta":{"type":"textDelta","text":"!"}}
        {"type":"serverCompletionEvent","metadata":{"requestId":"req-123","duration":1500}}
        ```

      operationId: invokeAgent
      tags:
        - Agent
      parameters:
        - name: Authorization
          in: header
          description: |
            JWT Bearer Token for authentication.
            User ID is extracted from JWT payload (sub, userId, user_id, or username).
            Format: Bearer <token>
          required: true
          schema:
            type: string
            pattern: '^Bearer .+$'
            example: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
        - name: X-Amzn-Bedrock-AgentCore-Runtime-Session-Id
          in: header
          description: |
            Session ID (optional).
            When specified, conversation history is maintained and context can be continued.
          required: false
          schema:
            type: string
            pattern: '^[a-zA-Z0-9-_]{1,200}$'
            example: session-abc123-xyz789
      requestBody:
        required: true
        description: AI agent invocation request
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InvokeRequest'
            examples:
              simple_query:
                summary: Simple question
                value:
                  prompt: 'What is the weather in Tokyo?'
              with_session:
                summary: With session and memory
                value:
                  prompt: 'What did we discuss earlier?'
                  memoryEnabled: true
                  memoryTopK: 10
              with_custom_model:
                summary: With custom model and tools
                value:
                  prompt: 'Analyze this data'
                  modelId: 'anthropic.claude-sonnet-4-5-20250929-v1:0'
                  enabledTools:
                    - 'file_editor'
                    - 's3_list_files'
                  systemPrompt: 'You are a data analyst.'

      responses:
        '200':
          description: |
            Streaming response success

            **Important**: This response is NDJSON format streaming.
            Each line is sent as an individual JSON event object.

            **Streaming Processing Method**:
            1. Read response body line by line
            2. Parse each line as JSON
            3. Determine event type by `type` property
            4. Execute processing based on event
          headers:
            Content-Type:
              schema:
                type: string
                example: 'text/plain; charset=utf-8'
            Cache-Control:
              schema:
                type: string
                example: 'no-cache'
            Connection:
              schema:
                type: string
                example: 'keep-alive'
          content:
            text/plain:
              schema:
                type: string
                description: |
                  NDJSON streaming response

                  Each line is one of the following event types:
                  - modelContentBlockDeltaEvent (text generation)
                  - modelContentBlockStartEvent (tool use start)
                  - modelContentBlockStopEvent (content block end)
                  - beforeInvocationEvent (agent start)
                  - afterInvocationEvent (agent end)
                  - beforeToolsEvent (before tool execution)
                  - afterToolsEvent (after tool execution)
                  - serverCompletionEvent (processing complete)
                  - serverErrorEvent (error)
                format: ndjson
              examples:
                streaming_response:
                  summary: Streaming response example
                  value: |
                    {"type":"beforeInvocationEvent"}
                    {"type":"modelContentBlockDeltaEvent","delta":{"type":"textDelta","text":"The weather in Tokyo is"}}
                    {"type":"modelContentBlockStartEvent","start":{"type":"toolUseStart","name":"weather_get_forecast","toolUseId":"tool-123"}}
                    {"type":"beforeToolsEvent"}
                    {"type":"afterToolsEvent"}
                    {"type":"modelContentBlockDeltaEvent","delta":{"type":"textDelta","text":"sunny."}}
                    {"type":"afterInvocationEvent"}
                    {"type":"serverCompletionEvent","metadata":{"requestId":"req-abc123","duration":1500,"sessionId":"session-xyz","conversationLength":2}}

        '400':
          description: Request error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                empty_prompt:
                  summary: Empty prompt
                  value:
                    error: 'Empty prompt provided'

        '500':
          description: |
            Server error

            **Note**: Errors during request processing include `requestId`,
            but errors from global error handler do not include `requestId`.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                server_error_with_request_id:
                  summary: Error during request processing
                  value:
                    error: 'Internal server error'
                    message: 'Agent initialization failed'
                    requestId: 'req-abc123'
                global_server_error:
                  summary: Global error handler
                  value:
                    error: 'Internal Server Error'
                    message: 'Unhandled exception occurred'

        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

        '404':
          $ref: '#/components/responses/NotFoundError'

components:
  schemas:
    # === Request ===
    InvokeRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          description: Prompt to send to AI agent
          minLength: 1
          maxLength: 10000
          example: 'Tell me about the weather in Tokyo'
        modelId:
          type: string
          description: Model ID to use (optional, uses environment variable if not specified)
          example: 'anthropic.claude-sonnet-4-5-20250929-v1:0'
        enabledTools:
          type: array
          description: |
            Array of tool names to enable (optional).
            - undefined: All tools enabled
            - []: No tools enabled
            - ['tool1', 'tool2']: Only specified tools enabled
          items:
            type: string
          example:
            - 'file_editor'
            - 's3_list_files'
            - 'tavily_search'
        systemPrompt:
          type: string
          description: Custom system prompt (optional)
          example: 'You are a helpful assistant specialized in data analysis.'
        storagePath:
          type: string
          description: S3 directory path selected by user (optional)
          example: '/projects/analysis'
        memoryEnabled:
          type: boolean
          description: 'Whether to enable long-term memory (default: false)'
          default: false
        memoryTopK:
          type: number
          description: 'Number of long-term memories to retrieve (default: 10)'
          default: 10
          minimum: 1
          maximum: 50
        mcpConfig:
          type: object
          description: User-defined MCP server configuration (optional)
          additionalProperties: true

    # === Response ===
    ServiceInfo:
      type: object
      properties:
        service:
          type: string
          description: Service name
          example: 'AgentCore Runtime Agent'
        version:
          type: string
          description: Version
          example: '0.1.0'
        endpoints:
          type: object
          description: Available endpoints
          properties:
            health:
              type: string
              example: 'GET /ping'
            invoke:
              type: string
              example: 'POST /invocations'
        status:
          type: string
          description: Service status
          example: 'running'

    HealthCheck:
      type: object
      properties:
        status:
          type: string
          description: Service status
          enum: [Healthy, Unhealthy]
          example: 'Healthy'
        time_of_last_update:
          type: integer
          description: Last update time (UNIX timestamp)
          example: 1703836800

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error type
          example: 'Bad Request'
        message:
          type: string
          description: Error message (optional)
          example: 'Empty prompt provided'
        requestId:
          type: string
          description: Request ID (optional)
          format: uuid
          example: 'req-abc123'

    NotFoundResponse:
      type: object
      required:
        - error
        - message
        - availableEndpoints
      properties:
        error:
          type: string
          description: Error type
          enum: ['Not Found']
          example: 'Not Found'
        message:
          type: string
          description: Detailed message about unfound endpoint
          pattern: '^Endpoint [A-Z]+ .+ not found$'
          example: 'Endpoint GET /unknown not found'
        availableEndpoints:
          type: array
          description: List of available endpoints
          items:
            type: string
            pattern: '^[A-Z]+ /.*$'
          minItems: 3
          maxItems: 3
          example:
            - 'GET /'
            - 'GET /ping'
            - 'POST /invocations'

    # === Streaming Events (Reference schemas) ===
    StreamEvent:
      type: object
      description: |
        Basic structure of streaming events
        **Note**: Actual response is sent in NDJSON format
      discriminator:
        propertyName: type
      required:
        - type
      properties:
        type:
          type: string
          description: Event type
          enum:
            - modelContentBlockDeltaEvent
            - modelContentBlockStartEvent
            - modelContentBlockStopEvent
            - modelMessageStartEvent
            - modelMessageStopEvent
            - messageAddedEvent
            - modelMetadataEvent
            - agentResult
            - textBlock
            - modelStreamEventHook
            - beforeInvocationEvent
            - afterInvocationEvent
            - beforeModelCallEvent
            - afterModelCallEvent
            - beforeToolsEvent
            - afterToolsEvent
            - serverCompletionEvent
            - serverErrorEvent

    TextDeltaEvent:
      allOf:
        - $ref: '#/components/schemas/StreamEvent'
        - type: object
          properties:
            type:
              type: string
              enum: [modelContentBlockDeltaEvent]
            delta:
              type: object
              required:
                - type
              properties:
                type:
                  type: string
                  enum: [textDelta]
                text:
                  type: string
                  description: Generated text fragment
                  example: 'Hello'

    ToolUseStartEvent:
      allOf:
        - $ref: '#/components/schemas/StreamEvent'
        - type: object
          properties:
            type:
              type: string
              enum: [modelContentBlockStartEvent]
            start:
              type: object
              properties:
                type:
                  type: string
                  enum: [toolUseStart]
                name:
                  type: string
                  description: Tool name
                  example: 'weather_get_forecast'
                toolUseId:
                  type: string
                  description: Tool use ID
                  example: 'tool-abc123'

    ServerCompletionEvent:
      allOf:
        - $ref: '#/components/schemas/StreamEvent'
        - type: object
          properties:
            type:
              type: string
              enum: [serverCompletionEvent]
            metadata:
              type: object
              required:
                - requestId
                - sessionId
              properties:
                requestId:
                  type: string
                  description: Request ID
                  format: uuid
                  example: 'req-abc123'
                duration:
                  type: number
                  description: Processing time (milliseconds)
                  minimum: 0
                  example: 1500
                sessionId:
                  type: string
                  description: |
                    Session ID.
                    Set to 'none' if not specified in header.
                  example: 'session-xyz789'
                  default: 'none'
                actorId:
                  type: string
                  description: User ID
                  example: 'user-123'
                conversationLength:
                  type: integer
                  description: Number of messages in conversation
                  minimum: 1
                  example: 2
                agentMetadata:
                  type: object
                  description: Metadata from agent creation
                  properties:
                    loadedMessagesCount:
                      type: integer
                    longTermMemoriesCount:
                      type: integer
                    toolsCount:
                      type: integer

    ServerErrorEvent:
      allOf:
        - $ref: '#/components/schemas/StreamEvent'
        - type: object
          properties:
            type:
              type: string
              enum: [serverErrorEvent]
            error:
              type: object
              required:
                - message
              properties:
                message:
                  type: string
                  description: Error message
                  example: 'Agent streaming error: Connection timeout'
                requestId:
                  type: string
                  description: Request ID
                  format: uuid
                  example: 'req-abc123'

  responses:
    NotFoundError:
      description: Endpoint not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/NotFoundResponse'
          example:
            error: 'Not Found'
            message: 'Endpoint POST /unknown not found'
            availableEndpoints:
              - 'GET /'
              - 'GET /ping'
              - 'POST /invocations'

tags:
  - name: Health
    description: Health check endpoints
  - name: Agent
    description: AI agent invocation
  - name: Service
    description: Service information

x-readme:
  explorer-enabled: true
  proxy-enabled: true
