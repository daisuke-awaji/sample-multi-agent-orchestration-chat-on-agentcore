name: PR Auto Deploy

on:
  pull_request:
    types: [labeled, closed]

permissions:
  id-token: write
  contents: read
  pull-requests: write # For posting comments

jobs:
  deploy:
    if: github.event.label.name == 'auto-deploy' && github.event.action == 'labeled'
    # Note: Amazon Bedrock AgentCore Runtime requires ARM64 architecture.
    # We use ubuntu-latest with QEMU emulation because ARM runners (ubuntu-24.04-arm)
    # are not available for private repositories.
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up QEMU for cross-platform Docker builds (x86_64 -> ARM64)
      # Required because AgentCore Runtime only supports ARM64 architecture
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::891376971424:role/GitHubActionsRole
          aws-region: ap-northeast-1
          role-session-name: github-actions-pr-${{ github.event.pull_request.number }}

      - name: Install dependencies
        run: npm ci

      - name: Bootstrap CDK (if needed)
        run: |
          echo "Checking CDK bootstrap status..."
          npx cdk bootstrap || echo "Bootstrap already completed or failed"

      - name: Deploy PR environment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Deploying PR environment: pr-${PR_NUMBER}"
          npx cdk deploy --require-approval never --all -c env=pr-${PR_NUMBER}

      - name: Get deployment outputs
        id: outputs
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          STACK_NAME="AgentCoreAppPr${PR_NUMBER}"

          # Get CloudFront URL
          FRONTEND_URL=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendUrl`].OutputValue' \
            --output text \
            --region ap-northeast-1 || echo "N/A")

          # Get Backend API URL
          BACKEND_URL=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs[?OutputKey==`BackendApiUrl`].OutputValue' \
            --output text \
            --region ap-northeast-1 || echo "N/A")

          # Get Runtime Endpoint
          RUNTIME_URL=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs[?OutputKey==`RuntimeInvocationEndpoint`].OutputValue' \
            --output text \
            --region ap-northeast-1 || echo "N/A")

          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "runtime_url=${RUNTIME_URL}" >> $GITHUB_OUTPUT

      - name: Comment PR with deployment info
        uses: actions/github-script@v7
        env:
          FRONTEND_URL: ${{ steps.outputs.outputs.frontend_url }}
          BACKEND_URL: ${{ steps.outputs.outputs.backend_url }}
          RUNTIME_URL: ${{ steps.outputs.outputs.runtime_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const frontendUrl = process.env.FRONTEND_URL;
            const backendUrl = process.env.BACKEND_URL;
            const runtimeUrl = process.env.RUNTIME_URL;

            const body = `## üöÄ PR Environment Deployed Successfully!

            **Environment:** \`pr-${prNumber}\`
            **Stack:** \`AgentCoreAppPr${prNumber}\`

            ### üîó Endpoints

            - **Frontend:** ${frontendUrl}
            - **Backend API:** ${backendUrl}
            - **Runtime:** ${runtimeUrl}

            ### ‚ÑπÔ∏è Information

            This is a temporary environment for testing this PR. It will be automatically deleted when the PR is closed.

            **Note:** First-time access may take a few moments to warm up the Lambda functions.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Post deployment failure comment
        if: failure()
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;

            const body = `## ‚ùå PR Environment Deployment Failed

            **Environment:** \`pr-${prNumber}\`

            The deployment failed. Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  cleanup:
    if: github.event.action == 'closed' && contains(github.event.pull_request.labels.*.name, 'auto-deploy')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::891376971424:role/GitHubActionsRole
          aws-region: ap-northeast-1
          role-session-name: github-actions-pr-${{ github.event.pull_request.number }}-cleanup

      - name: Install dependencies
        run: npm ci

      - name: Destroy PR environment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          STACK_NAME="AgentCoreAppPr${PR_NUMBER}"
          echo "Checking if stack ${STACK_NAME} exists..."

          if aws cloudformation describe-stacks --stack-name ${STACK_NAME} --region ap-northeast-1 2>/dev/null; then
            echo "Stack found. Destroying PR environment: pr-${PR_NUMBER}"
            npx cdk destroy --force --all -c env=pr-${PR_NUMBER}
            echo "Stack destroyed successfully"
          else
            echo "Stack not found. Nothing to clean up."
          fi

      - name: Comment PR with cleanup info
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;

            const body = `## üßπ PR Environment Cleaned Up

            **Environment:** \`pr-${prNumber}\`
            **Stack:** \`AgentCoreAppPr${prNumber}\`

            The temporary PR environment has been deleted.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Post cleanup failure comment
        if: failure()
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;

            const body = `## ‚ö†Ô∏è PR Environment Cleanup Failed

            **Environment:** \`pr-${prNumber}\`

            The cleanup failed. Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.

            You may need to manually delete the stack \`AgentCoreAppPr${prNumber}\` in the AWS Console.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
